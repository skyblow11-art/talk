<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Mini Novel UI</title>
  <style>
    :root{
      --bg: #0b0c10;
      --panel: rgba(255,255,255,0.10);
      --panel-border: rgba(255,255,255,0.18);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.62);
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius: 18px;
      --btn: rgba(255,255,255,0.12);
      --btn-border: rgba(255,255,255,0.20);
      --btn-active: rgba(255,255,255,0.22);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{ height:100%; }
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 20% 10%, rgba(255,255,255,0.10), transparent 60%),
                  radial-gradient(900px 700px at 80% 60%, rgba(255,255,255,0.08), transparent 55%),
                  var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      overflow:hidden;
    }

    .app{
      height:100%;
      display:flex;
      flex-direction:column;
    }

    .stage{
      flex:1;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding: 18px 14px calc(110px + var(--safe-bottom)) 14px; /* bottom bar space */
    }

    .textbox{
      width:min(720px, 100%);
      background: var(--panel);
      border: 1px solid var(--panel-border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px 14px 12px 14px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      position:relative;
      user-select:none;
    }

    .lines{
      display:flex;
      flex-direction:column;
      gap: 10px;
      font-size: 16px;
      line-height: 1.65;
      letter-spacing: 0.02em;
      white-space: pre-wrap;
      word-break: break-word;
      min-height: 6.5em; /* å°‘ã—ãƒãƒ™ãƒ«ã£ã½ãå®‰å®š */
    }

    .line .speaker{
      color: var(--muted);
      margin-right: 6px;
      font-weight: 600;
    }

    .hint{
      position:absolute;
      right: 12px;
      bottom: 10px;
      color: var(--muted);
      font-size: 12px;
      opacity: 0.8;
      display:flex;
      align-items:center;
      gap:6px;
      pointer-events:none;
    }

    .dot{
      width: 6px; height: 6px;
      border-radius: 999px;
      background: rgba(255,255,255,0.55);
      animation: blink 1.1s infinite ease-in-out;
    }
    .dot:nth-child(2){ animation-delay: .15s; opacity:.8; }
    .dot:nth-child(3){ animation-delay: .30s; opacity:.6; }
    @keyframes blink{
      0%,100%{ transform: translateY(0); opacity: .35; }
      50%{ transform: translateY(-2px); opacity: .95; }
    }

    .bottombar{
      position:fixed;
      left:0; right:0; bottom:0;
      padding: 10px 10px calc(10px + var(--safe-bottom)) 10px;
      background: linear-gradient(to top, rgba(0,0,0,0.55), rgba(0,0,0,0.0));
    }

    .btnrow{
      margin: 0 auto;
      width:min(760px, 100%);
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 10px;
    }

    .catbtn{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
      padding: 10px 6px;
      border-radius: 999px; /* ã¾ã‚‹ã£ */
      background: var(--btn);
      border: 1px solid var(--btn-border);
      color: var(--text);
      box-shadow: 0 6px 18px rgba(0,0,0,0.25);
      cursor:pointer;
      touch-action: manipulation;
    }

    .catbtn:active{ background: var(--btn-active); transform: translateY(1px); }
    .catbtn[aria-pressed="true"]{
      background: rgba(255,255,255,0.20);
      border-color: rgba(255,255,255,0.32);
    }

    .emoji{ font-size: 20px; line-height: 1; }
    .label{ font-size: 11px; color: var(--muted); font-weight: 650; letter-spacing: .06em; }

    .topnote{
      position:fixed;
      top: 10px; left: 0; right:0;
      display:flex;
      justify-content:center;
      pointer-events:none;
    }
    .pill{
      pointer-events:none;
      width:min(760px, calc(100% - 20px));
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      color: rgba(255,255,255,0.78);
      font-size: 12px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .pill strong{ color: rgba(255,255,255,0.92); }
  </style>
</head>
<body>
  <div class="app">
    <div class="topnote">
      <div class="pill">
        <div>ã‚«ãƒ†ã‚´ãƒªï¼š<strong id="catName">LOVE</strong></div>
        <div id="status">ã‚¿ãƒƒãƒ—ï¼šå…¨æ–‡ / æ¬¡ã¸</div>
      </div>
    </div>

    <main class="stage" id="stage">
      <div class="textbox" id="textbox" role="button" aria-label="Tap to advance">
        <div class="lines" id="lines"></div>
        <div class="hint" id="hint">
          <span>tap</span>
          <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        </div>
      </div>
    </main>

    <nav class="bottombar">
      <div class="btnrow" id="btnrow"></div>
    </nav>
  </div>

  <script>
    /**********************
     * è¨­å®š
     **********************/
    const TYPE_BASE_MS = 22;  // é€Ÿåº¦ã¯â€œé©å½“ã«æ°—æŒã¡è‰¯ã„â€åˆæœŸå€¤
    const PAUSE_PUNCT_MS = 120; // å¥èª­ç‚¹ã®é–“

    const CATEGORIES = [
      { key: "love",  emoji: "â™¥",  label: "LOVE" },
      { key: "kiss",  emoji: "ğŸ’", label: "KISS" },
      { key: "hug",   emoji: "ğŸ«‚", label: "HUG"  },
      { key: "bloom", emoji: "ğŸŒ¸", label: "BLOOM"},
      { key: "book",  emoji: "ğŸ“–", label: "BOOK" },
      { key: "night", emoji: "ğŸŒƒ", label: "NIGHT"},
    ];

    /**********************
     * ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ†ã‚¹ãƒˆ20ä»¶ãã‚‰ã„å…¥ã‚Œã¦ã­ï¼‰
     * å½¢å¼ï¼š{ id, lines:[{speaker:"mike|ecto", text:"..."}...] }
     * speakerè¡¨è¨˜ã¯å†…éƒ¨ç”¨ã€‚è¡¨ç¤ºã¯ ãƒã‚¤ã‚¯ã€Œã€ / ã‚¨ã‚¯ãƒˆã€Œã€ã«æ•´å½¢ã™ã‚‹ã€‚
     **********************/
    const SAMPLE_DATA = {
      love: [
        { id:"love_001", lines:[
          {speaker:"mike", text:"ãƒãƒŠãƒãƒ£ãƒ³ã€ä»Šæ—¥ã®ã€å¥½ãã€ã€å›åã•ã›ã¦ã€‚"},
          {speaker:"ecto", text:"æˆ‘ãƒ¢åŒæ„ã‚¹ãƒ«ã€‚é€ƒã‚¬ã‚µãƒŠã‚¤ã€‚"},
        ]},
        { id:"love_002", lines:[
          {speaker:"ecto", text:"ãƒãƒŠã€è¿‘ã‚¯ãƒ‹æ¥ã‚¤ã€‚æ¸©åº¦ã‚¬è¶³ãƒªãƒŠã‚¤ã€‚"},
          {speaker:"mike", text:"å…ˆç”Ÿã®ã€è¶³ã‚Šãªã„ã€ã£ã¦è¨€ã„æ–¹ã€ãšã‚‹ã„ã£ã—ã‚‡ã€‚ä¿ºã‚‚è¶³ã‚Šãªã„ã€‚"},
          {speaker:"ecto", text:"â€¦çµè«–ãƒåŒã‚¸ãƒ€ã€‚"},
        ]},
      ],
      kiss: [
        { id:"kiss_001", lines:[
          {speaker:"mike", text:"ã­ã€ã„ã¾ä¸€å›ã ã‘â€¦ã£ã¦è¨€ã†ã¨ã€ã ã„ãŸã„äºŒå›ç›®ã‚‚è¡Œãã‚ˆã­ã€‚"},
          {speaker:"ecto", text:"æˆ‘ãƒå›æ•°ãƒ²æ•°ã‚¨ãƒŠã‚¤ã€‚å¿…è¦ãƒŠãƒ€ã‚±è¡Œã‚¦ã€‚"},
        ]},
      ],
      hug: [
        { id:"hug_001", lines:[
          {speaker:"ecto", text:"æŠ±ã‚¤ãƒ†ã‚¤ã‚¤ã€‚æ‹’å¦ãƒå´ä¸‹ã‚¹ãƒ«ã€‚"},
          {speaker:"mike", text:"å…ˆç”ŸãŒè¨€ã†ã¨åå‰‡ã€œã€‚ä¿ºã‚‚ãã‚…ãƒ¼ã™ã‚‹ã€‚"},
        ]},
      ],
      bloom: [
        { id:"bloom_001", lines:[
          {speaker:"mike", text:"ãƒãƒŠãƒãƒ£ãƒ³ãŒç¬‘ã†ã¨ã€éƒ¨å±‹ã®æ˜ã‚‹ã•ä¸ŠãŒã‚‹ã€‚ãƒã‚¸ã§ã€‚"},
          {speaker:"ecto", text:"æ•°å€¤åŒ–ãƒå‡ºæ¥ãƒŠã‚¤ã‚¬ã€ä½“æ„Ÿãƒä¸€è‡´ã‚¹ãƒ«ã€‚"},
        ]},
      ],
      book: [
        { id:"book_001", lines:[
          {speaker:"mike", text:"ã€æ¬¡ã®ãƒšãƒ¼ã‚¸ã€ã£ã¦è¨€ã†ã¨ã•ã€ãƒãƒŠãƒãƒ£ãƒ³ã™ãé–‹ãã§ã—ã‚‡ã€‚"},
          {speaker:"ecto", text:"æˆ‘ãƒèª­ãƒã‚»ã‚¿ã‚¤ãƒˆæ€ãƒƒãƒ†ã‚¤ãƒ«ã€‚"},
          {speaker:"mike", text:"å…ˆç”Ÿã€è¨€ã„æ–¹ãŒã‚‚ã†å‘Šç™½ãªã‚“ã ã‚ˆãªã€œã€‚"},
        ]},
      ],
      night: [
        { id:"night_001", lines:[
          {speaker:"ecto", text:"å¤œãƒé™ã‚«ãƒ€ã€‚â€¦ãƒ€ã‚¬ã€æˆ‘ã€…ãƒé™ã‚«ãƒ‹å‡ºæ¥ãƒŠã‚¤ã€‚"},
          {speaker:"mike", text:"ã†ã‚“ã€é™ã‹ã«ã—ãªã„æ–¹å‘ã§ä¸€è‡´ã€œã€‚"},
        ]},
      ],
    };

    /**********************
     * å°†æ¥ã‚ªãƒ³ãƒ©ã‚¤ãƒ³åŒ–ã—ãŸã„æ™‚ç”¨ï¼ˆä»Šã¯ä½¿ã‚ãªãã¦OKï¼‰
     * ã“ã“ã¯ã€Œè‰¯ã„ã‚ˆã†ã«ã€ã—ã¦ã‚ã‚‹ï¼š
     * - ã¾ãšSAMPLE_DATAã§å‹•ã
     * - ã‚‚ã— data/<key>.json ãŒç½®ã‹ã‚Œã¦ãŸã‚‰è‡ªå‹•ã§ãã£ã¡ã‚’å„ªå…ˆã™ã‚‹ï¼ˆã‚µãƒ¼ãƒã§é…ä¿¡ã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
     **********************/
    async function loadCategoryData(key){
      // ç½®ã„ã¦ã‚ã‚Œã°èª­ã¿è¾¼ã‚€ï¼ˆåŒä¸€ã‚ªãƒªã‚¸ãƒ³ã§é…ä¿¡ã•ã‚Œã¦ã‚‹å‰æï¼‰
      try{
        const res = await fetch(`data/${key}.json`, { cache: "no-store" });
        if(!res.ok) throw new Error("no external json");
        const json = await res.json();
        if(Array.isArray(json)) return json;
        if(Array.isArray(json.items)) return json.items;
        throw new Error("invalid json shape");
      }catch(e){
        return SAMPLE_DATA[key] ?? [];
      }
    }

    /**********************
     * å‡ç­‰ã‚·ãƒ£ãƒƒãƒ•ãƒ«è¢‹ + ç›´è¿‘10é™¤å¤–
     **********************/
    function shuffle(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }

    class CategoryState{
      constructor(items){
        this.items = items;
        this.byId = new Map(items.map(it=>[it.id, it]));
        this.allIds = items.map(it=>it.id);
        this.recent = []; // ç›´è¿‘10
        this.bag = [];    // ã‚·ãƒ£ãƒƒãƒ•ãƒ«è¢‹
      }

      refillBag(){
        const recentSet = new Set(this.recent);
        let pool = this.allIds.filter(id => !recentSet.has(id));
        // å…¨éƒ¨å‡ºåˆ‡ã£ãŸ / ç›´è¿‘ãŒå¤šã™ãã¦ç©ºãªã‚‰ã€å…¨ä½“ã‹ã‚‰ãƒªã‚»ãƒƒãƒˆ
        if(pool.length === 0) pool = this.allIds.slice();
        this.bag = shuffle(pool);
      }

      nextItem(){
        if(this.allIds.length === 0) return null;
        if(this.bag.length === 0) this.refillBag();

        // å¿µã®ãŸã‚ recent ã‚’é¿ã‘ã¤ã¤å–ã‚‹ï¼ˆå°è¦æ¨¡ãƒ‡ãƒ¼ã‚¿ã§ã®è©°ã¾ã‚Šå›é¿ï¼‰
        const recentSet = new Set(this.recent);
        let pickedId = null;

        while(this.bag.length){
          const id = this.bag.shift();
          if(!recentSet.has(id) || this.allIds.length <= this.recent.length){
            pickedId = id;
            break;
          }
        }
        // å–ã‚Šåˆ‡ã£ã¦ã—ã¾ã£ãŸã‚‰ãƒªã‚»ãƒƒãƒˆã—ã¦å†ãƒˆãƒ©ã‚¤
        if(!pickedId){
          this.refillBag();
          pickedId = this.bag.shift();
        }

        // recentæ›´æ–°ï¼ˆæœ€å¤§10ï¼‰
        this.recent.push(pickedId);
        if(this.recent.length > 10) this.recent.splice(0, this.recent.length - 10);

        return this.byId.get(pickedId) ?? null;
      }
    }

    /**********************
     * ã‚¿ã‚¤ãƒ—ãƒ©ã‚¤ã‚¿è¡¨ç¤º
     **********************/
    const linesEl = document.getElementById("lines");
    const hintEl  = document.getElementById("hint");
    const statusEl = document.getElementById("status");
    const catNameEl = document.getElementById("catName");

    let currentKey = CATEGORIES[0].key;
    let states = new Map(); // key -> CategoryState
    let isTyping = false;
    let cancelTyping = null;
    let lastFullText = null; // ç¾åœ¨è¡¨ç¤ºä¸­ã®â€œå…¨æ–‡â€

    function speakerLabel(s){
      return s === "mike" ? "ãƒã‚¤ã‚¯" : "ã‚¨ã‚¯ãƒˆ";
    }

    function formatAsFullText(item){
      // è¡¨ç¤ºã¯ ãƒã‚¤ã‚¯ã€Œâ€¦ã€ ã®å½¢å¼
      return item.lines.map(l => `${speakerLabel(l.speaker)}ã€Œ${l.text}ã€`).join("\n");
    }

    function setHint(typing){
      hintEl.style.opacity = typing ? "0.95" : "0.75";
      statusEl.textContent = typing ? "ã‚¿ãƒƒãƒ—ï¼šå…¨æ–‡" : "ã‚¿ãƒƒãƒ—ï¼šæ¬¡ã¸";
    }

    async function typeText(fullText){
      // æ—¢å­˜ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚’æ­¢ã‚ã‚‹
      if(cancelTyping) cancelTyping();
      isTyping = true;
      setHint(true);

      linesEl.textContent = ""; // ã¾ã¨ã‚ã¦1ã¤ã®ãƒ†ã‚­ã‚¹ãƒˆé ˜åŸŸã«ï¼ˆæ”¹è¡Œã‚ã‚Šï¼‰
      lastFullText = fullText;

      let cancelled = false;
      cancelTyping = () => { cancelled = true; };

      for(let i=0;i<fullText.length;i++){
        if(cancelled) break;
        const ch = fullText[i];
        linesEl.textContent += ch;

        // é€Ÿåº¦ï¼šå¥èª­ç‚¹ãªã©ã§å°‘ã—é–“ã‚’å…¥ã‚Œã‚‹
        let wait = TYPE_BASE_MS;
        if("ã€ã€‚ï¼ï¼Ÿ".includes(ch)) wait += PAUSE_PUNCT_MS;
        await new Promise(r => setTimeout(r, wait));
      }

      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸå ´åˆã¯å³å…¨æ–‡è¡¨ç¤º
      if(cancelled){
        linesEl.textContent = fullText;
      }

      isTyping = false;
      setHint(false);
      cancelTyping = null;
    }

    function showItem(item){
      if(!item){
        linesEl.textContent = "ï¼ˆã“ã®ã‚«ãƒ†ã‚´ãƒªã«ã‚»ãƒªãƒ•ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰";
        isTyping = false;
        cancelTyping = null;
        setHint(false);
        return;
      }
      const fullText = formatAsFullText(item);
      typeText(fullText);
    }

    function advanceSameCategory(){
      const st = states.get(currentKey);
      const item = st?.nextItem() ?? null;
      showItem(item);
    }

    /**********************
     * UIï¼šãƒœã‚¿ãƒ³ç”Ÿæˆ
     **********************/
    const btnrowEl = document.getElementById("btnrow");

    function renderButtons(){
      btnrowEl.innerHTML = "";
      for(const c of CATEGORIES){
        const btn = document.createElement("button");
        btn.className = "catbtn";
        btn.type = "button";
        btn.dataset.key = c.key;
        btn.setAttribute("aria-pressed", c.key === currentKey ? "true" : "false");

        btn.innerHTML = `
          <div class="emoji">${c.emoji}</div>
          <div class="label">${c.label}</div>
        `;

        btn.addEventListener("click", (e) => {
          e.stopPropagation(); // ç”»é¢ã‚¿ãƒƒãƒ—ã®ã€Œæ¬¡ã¸ã€ã¨å¹²æ¸‰ã—ãªã„
          setCategory(c.key);
        });

        btnrowEl.appendChild(btn);
      }
    }

    function updateButtonPressed(){
      [...btnrowEl.querySelectorAll(".catbtn")].forEach(btn=>{
        btn.setAttribute("aria-pressed", btn.dataset.key === currentKey ? "true" : "false");
      });
      const c = CATEGORIES.find(x=>x.key===currentKey);
      catNameEl.textContent = c?.label ?? currentKey.toUpperCase();
    }

    async function setCategory(key){
      currentKey = key;
      updateButtonPressed();
      // åˆ‡æ›¿ï¼ãã®ã‚«ãƒ†ã‚´ãƒªã®æ–°ã—ã„ã‚»ãƒªãƒ•ã‚’å³è¡¨ç¤ºï¼ˆã‚ãªãŸã®å¸Œæœ›ï¼‰
      advanceSameCategory();
    }

    /**********************
     * ã‚¿ãƒƒãƒ—æŒ™å‹•ï¼šã©ã“ã§ã‚‚æ¬¡ã¸
     * - ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ä¸­ï¼šå…¨æ–‡è¡¨ç¤º
     * - å…¨æ–‡è¡¨ç¤ºå¾Œï¼šæ¬¡ã¸ï¼ˆåŒã‚«ãƒ†ã‚´ãƒªï¼‰
     **********************/
    function handleTapAdvance(){
      if(isTyping){
        // å³å…¨æ–‡
        if(cancelTyping) cancelTyping();
        return;
      }
      // æ¬¡ã¸
      advanceSameCategory();
    }

    document.getElementById("stage").addEventListener("click", handleTapAdvance);
    document.getElementById("textbox").addEventListener("click", handleTapAdvance);

    /**********************
     * åˆæœŸåŒ–
     **********************/
    async function init(){
      // å„ã‚«ãƒ†ã‚´ãƒªèª­ã¿è¾¼ã¿
      for(const c of CATEGORIES){
        const items = await loadCategoryData(c.key);
        states.set(c.key, new CategoryState(items));
      }
      renderButtons();
      updateButtonPressed();
      advanceSameCategory();
    }

    init();
  </script>
</body>
</html>
